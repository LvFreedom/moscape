{% extends "./inc/base.html" %} 
{% block style %}
<link href="/static/admin/js/jquery-ui-1.12.1.custom/jquery-ui.min.css"  rel="stylesheet" type="text/css"/>
<!--multidatespicker css-->
<link  rel="stylesheet" href="/static/admin/js/multidatespicker/jquery-ui.multidatespicker.css" type="text/css" />
{% endblock %}
{% block content %}
{#
<section class="vbox">
    <header class="header bg-light dk">
        <p>{{controller.meta_title}}</p>
    </header>
    <section class="scrollable wrapper">

        <section class="panel-default classify clear">
   <!--          <header class="panel-footer bg-white">
                
                <div class="row text-center no-gutter">
              
                    <div class="col-md-2 b-r b-light">
                        <p class="h3 font-bold m-t">{{user_count}}</p>
                        <p class="text-muted">用户</p>
                    </div>
                    
                    <div class="col-md-2 b-r b-light">
                        <p class="h3 font-bold m-t">{{action_count}}</p>
                        <p class="text-muted">行为</p>
                    </div>
                    <div class="col-md-2 b-r b-light">
                        <p class="h3 font-bold m-t">{{cate_count}}</p>
                        <p class="text-muted">栏目</p>
                    </div>
                    <div class="col-md-2 b-r b-light">
                        <p class="h3 font-bold m-t">{{type_count}}</p>
                        <p class="text-muted">分类</p>
                    </div>
                    <div class="col-md-2 b-r b-light">
                        <p class="h3 font-bold m-t">{{model_count}}</p>
                        <p class="text-muted">模型</p>
                    </div>
                    <div class="col-md-2">
                        <p class="h3 font-bold m-t">{{ext_count}}</p>
                        <p class="text-muted">插件</p>
                    </div>
                    
                </div>
                
            </header> -->
            <div class="bg-white equip-statistics">
                <div class="title text-center">
                    <a class="device-count" href="#" data-type="0">注册设备情况</a>
                </div>
                <div class="number">
                   <b class="col-xs-7">{{device_count}}</b>
                   <a class="col-xs-5 text-right" href="/admin/iot/index/cate_id/154">详情</a> 
                </div>
            </div>
            <div class="bg-white equip-statistics equip-statistics-2">
                <div class="title text-center">
                    <a class="register-count" href="#" data-type="1">设备开机情况</a>
                </div>
                <div class="number">
                    <b class="col-xs-7">{{register_count}}</b>
                    <a class="col-xs-5 text-right" href="/admin/iot/index/cate_id/151">详情</a> 
                </div>
            </div>
            <div class="bg-white equip-statistics">
                <div class="title text-center">
                    <a class="reader-count" href="#" data-type="2">设备读写情况</a>
                </div>
                <div class="number">
                    <b class="col-xs-7">{{notify_count}}</b>
                    <a class="col-xs-5 text-right" href="/admin/iot/index/cate_id/153">详情</a> 
                </div>
            </div>
        </section>
        <section>
            <div class="clear search-box">
                <!-- <form class="given-time" method="post">
                    <ul class="query-mode clear">
                        <li>
                            <label>输入具体时间：</label>
                            <input class="form-control given-date" name="given_date" type="text" placeholder="YYYY-MM-DD">
                            <input class="data-type" type="hidden" name="data_type" value="1">
                            <input class="time-type" type="hidden" name="time_type" value>
                        </li>
                        <li><a class="btn btn-info" data-time="by-hour">当天数据</a></li>
                    </ul>
                </form>
                <form class="period-time">
                    <ul class="query-mode clear">
                        <li class="clear">
                            <label>输入时间间隔：</label>
                            <input class="form-control start-date" name="start_date" type="text" placeholder="YYYY-MM-DD">
                            <b>至</b> 
                            <input class="form-control end-date" name="end_date" type="text" placeholder="YYYY-MM-DD">
                            <input class="data-type" type="hidden" name="data_type" value="1">
                            <input class="time-type" type="hidden" name="time_type" value>
                        </li>
                        <li><a class="btn btn-info" data-time="by-day">按天查询</a></li>
                        <li><a class="btn btn-info" data-time="by-week">按周查询</a></li>
                        <li><a class="btn btn-info" data-time="by-month">按月查询</a></li>
                    </ul>
                </form> -->
                <div id="calendar-box" class="col-xs-12 col-sm-4 col-md-4">
                    <ul class="clear time-type">
                        <li><a class="btn btn-info" data-time="by-hour">当天数据</a></li>
                        <li><a class="btn btn-info" data-time="by-day">按天查询</a></li>
                        <li><a class="btn btn-info" data-time="by-week">按周查询</a></li>
                        <li><a class="btn btn-info" data-time="by-month">按月查询</a></li>
                    </ul>
                    <input type="text" id="multidate" name="date|||{{field.name}}" class="form-control multidate" value="{%if data[field.name]==0%}{%else%}{{data[field.name]|multimoment('YYYY-MM-DD')}}{%endif%}" data-mark="{%if data[field.name]==0%}{%else%}{{data[field.name]}}{%endif%}" readonly="readonly" {% if field.is_must == 1 %}data-required="true"{%endif%}/>
                    <input class="data-type" type="hidden" name="data_type" value="1">
                    <div id='calendar'></div>
                </div>
                <div class="echart-box col-xs-12 col-sm-8 col-md-8">
                    <div id="chart" class="echart"></div>
                </div>
                
            </div>

            
        </section>
        
        <!--
        <div class="row">
            <div class="col-md-6">
                <section class="panel panel-default portlet-item">
                    <header class="panel-heading">
                        <ul class="nav nav-pills pull-right">
                            <li>
                                <a class="panel-toggle text-muted" href="#"><i class="fa fa-caret-down text-active"></i><i class="fa fa-caret-up text"></i></a>
                            </li>
                        </ul>
                        产品团队
                    </header>
                    <section class="panel-body">
                        <article class="media">
                            <div class="pull-left">
                                <span class="fa-stack fa-lg">
                        <i class="fa fa-circle fa-stack-2x"></i>
                        <i class="fa fa-hourglass fa-stack-1x text-white"></i>
                      </span>
                            </div>
                            <div class="media-body">
                                <h4 class="h4">总策划</h4>
                                <small class="block m-t-xs"><a href="http://www.peanutroll.com/blog" class="text-info" target="_blank">阿特</a> zhengqsh@126.com</small>
                            </div>
                        </article>
                        <div class="line pull-in"></div>
                        <article class="media">
                            <div class="pull-left">
                                <span class="fa-stack fa-lg">
                        <i class="fa fa-circle fa-stack-2x "></i>
                        <i class="fa fa-hourglass-1 fa-stack-1x text-white"></i>
                      </span>
                            </div>
                            <div class="media-body">
                                <h4 class="h4">产品设计及研发团队</h4>
                                <small class="block m-t-xs">阿特</small>
                            </div>
                        </article>
                        <div class="line pull-in"></div>
                        <article class="media">
                            <div class="pull-left">
                                <span class="fa-stack fa-lg">
                        <i class="fa fa-circle fa-stack-2x "></i>
                        <i class="fa fa-hourglass-2 fa-stack-1x text-white"></i>
                      </span>
                            </div>
                            <div class="media-body">
                                <h4 class="h4 ">界面及用户体验团队</h4>
                                <small class="block m-t-xs">阿特</small>
                            </div>
                        </article>
                        <div class="line pull-in"></div>
                        <article class="media">
                            <div class="pull-left">
                                <span class="fa-stack fa-lg">
                        <i class="fa fa-circle fa-stack-2x "></i>
                        <i class="fa fa-hourglass-3 fa-stack-1x text-white"></i>
                      </span>
                            </div>
                            <div class="media-body">
                                <h4 class="h4 ">文档编写</h4>
                                <small class="block m-t-xs">阿特，媄玅亽甡，<a href="https://github.com/phantomk" target="_blank" class="text-info">phantomk</a>，<a href="http://www.reake.com" target="_blank" class="text-info">reake</a></small>
                            </div>
                        </article>
                    </section>
                </section>
            </div>
            <div class="col-md-6">
                <section class="panel panel-info ">
                    <header class="panel-heading">
                        系统信息
                    </header>
                    <div class="list-group bg-white">
                        <div class="list-group-item">
                            <i class="fa fa-fw fa-info-circle"></i> PeanutRoll版本 : <span class=" text-muted">{{version}}</span>
                        </div>
                        <div class="list-group-item">
                            <i class="fa fa-fw fa-info-circle"></i> 服务器操作系统 : <span class=" text-muted">{{OS}}</span>
                        </div>
                        <div class="list-group-item">
                            <i class="fa fa-fw fa-info-circle"></i> nodejs版本 : <span class=" text-muted">{{ nodejs_v }}</span>
                        </div>
                        <div class="list-group-item">
                            <i class="fa fa-fw fa-info-circle"></i> MYSQL版本 ：<span class=" text-muted">{{mysqlv}}</span>
                        </div>
                        <div class="list-group-item">
                            <i class="fa fa-fw fa-info-circle"></i> ThinkJS ：<span class="text-muted">{{thinkjs}} [The Web framework beyond your dreams] <a href="https://thinkjs.org/doc.html" target="_blank">Getting Started</a> </span>
                        </div>

                    </div>
                </section>
            </div>


        </div>
        -->
    </section>
</section>
#}
{% endblock %}
{% block script %}
<script src="/static/admin/js/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script>
<!--multidatespicker-->
<script src="/static/admin/js/multidatespicker/jquery-ui.multidatespicker.js" type="text/javascript"></script>
{#
<script>
$(document).ready(function(){
	var type = $(".register-count").attr("data-type");
	var day = new Date().Format("yyyy-MM-dd");
    var time_type = "by-hour"
	$.ajax({
		type:'POST',
        url:'/admin/index/countsearch',
		data:{data_type:type,time_type:time_type,time_slot:day},
		success:function(data){
            paintEchart(data) 
		}
	})
    /*
    *加载日历
     */
    var defaultDate = new Date();
    $('#calendar').multiDatesPicker({
        //初始日期
        defaultDate:defaultDate,
        dateFormat: "yy-mm-dd",
        showMonthAfterYear:true,
        changeYear: true,
        changeMonth: true,
        monthNamesShort: ['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月'], 
        dayNamesMin: ['日','一','二','三','四','五','六'],
        //填值到input框
        altField: '#multidate',
        //多选的数量
        maxPicks: 2,
    });
})
/**
 * 为查询类型绑定单击事件
 */
$(".classify").on("click",".title>a",function(){
    if($(this).attr("class") == "device-count"){
        $("input.data-type").attr("value",'0')
        //重绘图表
        $.ajax({
            type:"POST",
            url:"/admin/index/countsearch",
            data:{data_type:0,time_type:"by-month"},
            success:function(data){
                paintEchart(data)
            }
        })
    }else if($(this).attr("class") == "register-count"){
        $("input.data-type").attr("value",'1')
        //重绘图表
        $.ajax({
            type:"POST",
            url:"/admin/index/countsearch",
            data:{data_type:1,time_type:"by-month"},
            success:function(data){
                paintEchart(data)
            }
        })
    }else if($(this).attr("class") == "reader-count"){
        $("input.data-type").attr("value",'2')
        //重绘图表
        $.ajax({
            type:"POST",
            url:"/admin/index/countsearch",
            data:{data_type:2,time_type:"by-month"},
            success:function(data){
                paintEchart(data)
            }
        })
    }
})
/*
*为查询精度绑定单击事件
 */
$(".time-type").on("click","a",function(){
    var data,start_date,end_date;
    //查询类型
    var data_type = $(".data-type").val();
    //时间精度
    var time_type = $(this).attr("data-time");
    
    var $val = $("#multidate").val();
    //console.log($val)
    if($val!=""&&$val!=undefined){
        data = $val.split(", ")
        start_date=data[0];
        end_date=data[1];
    }
    //console.log(data);
    //console.log(start_date);
    //console.log(end_date)
    if(time_type == "by-hour"){
            if(data =="" || data == undefined){
                //console.log(data_type,time_type,start_date,end_date)
                $.ajax({
                    type:"POST",
                    url:"/admin/index/countsearch",
                    data:{data_type:data_type,time_type:time_type,given_date:start_date},
                    success:function(data){
                        paintEchart(data)
                    }
                })
            }else {
                if(end_date!="" && end_date!=undefined){
                    toastr.error("查询当天数据请选择一个日期！");
                }else{
                    //console.log(data_type,time_type,start_date,end_date)
                    $.ajax({
                        type:"POST",
                        url:"/admin/index/countsearch",
                        data:{data_type:data_type,time_type:time_type,given_date:start_date},
                        success:function(data){
                            paintEchart(data)
                        }
                    })
                }
            }
        }else{
            if(data =="" || data == undefined){
                //console.log(data_type,time_type,start_date,end_date)
                $.ajax({
                    type:"POST",
                    url:"/admin/index/countsearch",
                    data:{data_type:data_type,time_type:time_type,start_date:start_date,end_date:end_date},
                    success:function(data){
                        paintEchart(data)
                    }
                })
            }else{ 
                if(end_date== "" || end_date==undefined){
                    toastr.error("请选择两个日期！");
                }else{
                    //console.log(data_type,time_type,start_date,end_date)
                    $.ajax({
                        type:"POST",
                        url:"/admin/index/countsearch",
                        data:{data_type:data_type,time_type:time_type,start_date:start_date,end_date:end_date},
                        success:function(data){
                            paintEchart(data)
                        }
                    })
                }
            }
        }
})

/**
 * 重绘图表
 */
function paintEchart(data){
    //console.log(data);
    var chart_data = data.data;
    var time=[];
    var count=[];
    var text;
    //echarts画图
    if(data.data_type == 0){
        for(var i=0;i<chart_data.length;i++){
            time.push(chart_data[i].register_time);
            count.push(chart_data[i].count);
            text = "注册设备数量";
        }
    }else if(data.data_type == 1){
        for(var i=0;i<chart_data.length;i++){
            time.push(chart_data[i].register_time);
            count.push(chart_data[i].count)
            text = "设备开机次数";
        }
    }else if(data.data_type == 2){
        for(var i=0;i<chart_data.length;i++){
            time.push(chart_data[i].notify_time);
            count.push(chart_data[i].count)
            text = "设备读写次数";
        }
    }

    var myChart = echarts.init(document.getElementById("chart"));
    myChart.title = "开机总次数"
    var colors = ['#5793f3', '#d14a61', '#675bba'];
    echarts.init(document.getElementById('chart')).setOption({
        tooltip: {
            trigger: 'axis',
            position: function (pt) {
                return [pt[0], '10%'];
            }
        },
        title: {
            left: 'center',
            text: text,
        },
        toolbox: {
            feature: {
                dataZoom: {
                    yAxisIndex: 'none'
                },
                restore: {},
                saveAsImage: {}
            }
        },
        xAxis: {
            name:"时间",
            type: 'category',
            boundaryGap: false,
            data:  time,
        },
        yAxis: {
            name:"次数",
            type: 'value',
            boundaryGap: [0, '100%']
        },
        dataZoom: [{
            type: 'inside',
            start: 0,
            end: 100
        }, {
            start: 0,
            end: 100,
            handleIcon: 'M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.3v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z',
            handleSize: '80%',
            handleStyle: {
                color: '#fff',
                shadowBlur: 3,
                shadowColor: 'rgba(0, 0, 0, 0.6)',
                shadowOffsetX: 2,
                shadowOffsetY: 2
            }
        }],
        series: [
            {
                name:text,
                type:'line',
                smooth:true,
                symbol: 'none',
                sampling: 'average',
                itemStyle: {
                    normal: {
                        color: '#7cb6cb'
                    }
                },
                areaStyle: {
                    normal: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                            offset: 0,
                            color: '#6cb6cb'
                        }, {
                            offset: 1,
                            color: '#06b0c8'
                        }])
                    }
                },
                data: count
            }
        ]
    })
}

/**
 * 获取当前时间
 */
Date.prototype.Format = function(fmt){
    var t = {
        "M+":this.getMonth() + 1,//月
        "d+":this.getDate(),//日
        "h+":this.getHours(),//小时
        "m+":this.getMinutes(),//分
        "s+":this.getSeconds(),//秒
        "q+":Math.floor((this.getMonth()+3)/3),//季
        "S": this.getMilliseconds() //毫秒 
    };
    if(/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length))
    for (var k in t)
    if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (t[k]) : (("00" + t[k]).substr(("" + t[k]).length)));
    return fmt;
}
function getWeekOfYear(date) {   
    var d1 = date; 
    var d3 = new Date(date); 
    var d2 = new Date(d3.getFullYear(), 0, 1);  
    var d = Math.round((d1 - d2) / 86400000);   
    return Math.ceil((d + ((d2.getDay() + 1) - 1)) / 7);   
};
</script>
#}
{% endblock %}